---
title: "BME 580 Project"
authors: "Michelle Li"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(psych) # Contains the winsor function and other helpful statistical tools
library(tidyverse) 
library(gridExtra)
library(corrplot)
```


```{r}
# Import CSV files
library(readr)
subject_info <- read_csv("subject-info.csv")
test_measure <- read_csv("test_measure.csv")
```

```{r}
# Look at head of datasets
head(subject_info,10)
dim(subject_info)
cat("Dimensions of subject_info:", dim(subject_info))
```
There are 992 rows and 8 columns in subject_info datset. 
```{r}
head(test_measure,10)
dim(test_measure)
cat("Dimensions of test_measure:", dim(test_measure))
```
There are 575087 rows and 9 columns in test_measure datset. 
```{r}
#Look at class types 
lapply(subject_info,class)
```
```{r}
lapply(test_measure,class)
```


```{r}
# Add new column for BMI
# Convert weight to lb from kg and height to inch from cm
# BMI formula = weight(lb)/height(cm)^2 * 703
subject_info <- subject_info %>% 
  add_column(bmi = (subject_info$Weight*2.2/(subject_info$Height*0.393701)**2)*703)
```
```{r}
summary(subject_info)
```


```{r}
# Look for missing information
# Percent of the total BMI observations are missing
sum(is.na(subject_info$bmi)==TRUE)/nrow(subject_info) * 100
```


```{r}
#Find mean ages based on gender
library(dplyr)
library(plyr)
#Change gender data type from integer to character
subject_info$Sex <-as.character(subject_info$Sex)
age_mean <- ddply(subject_info, "Sex", summarise, grp.mean=mean(Age))
head(age_mean)
```
```{r}
# Find minimum and maximum ages based on gender
age_range <- ddply(subject_info, "Sex", summarise, min_age=min(Age), max_age=max(Age))
head(age_range)
```

```{r}
# Graph density function
age_density = ggplot(subject_info, aes(x=Age, fill=Sex, color=Sex)) +
  geom_density(alpha = 0.5) +
  # Add mean lines
  geom_vline(data=age_mean, aes(xintercept=grp.mean, color=Sex), linetype="dashed") +
  labs(title= "Age Density across Sex",
       x = "Age (Years)",
       y = "Density") +
  theme(text = element_text(size=20))
# Add tickmarks for every 5 years for age 
age_density = age_density + scale_x_continuous(breaks=seq(0, 80, 5)) + theme_bw() + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank())
age_density
ggsave("age_density.png")
```
```{r}
#Summary stats for test_measure data
summary(test_measure)
```
```{r}
# Find number of tests per ID
library(dplyr)
freq_tests = count_(test_measure,'ID', sort= TRUE)
head(freq_tests, 15)
dim(freq_tests)

# Find frequency of speeds
freq_speeds = count_(test_measure, 'Speed', sort=TRUE)
head(freq_speeds, 15)
dim(freq_speeds)

# Find frequency of test time 
freq_time = count_(test_measure, 'time', sort=TRUE)
head(freq_time, 15)
dim(freq_time)
```
Participants do not perform the same number of tests. There is an uneven distribution of speeds. Speed 5 is the most frequent, followed by 4.9, and then 13. Need a way to make the data time independent. 


```{r}
#Look at average speed for the 857 unique participants 
speed_mean <- ddply(test_measure, "ID", summarise, grp.mean=mean(Speed))
head(speed_mean,15)
```

```{r}
# Speed range for each participant 
speed_range <- ddply(test_measure, "ID", summarise, min_speed = min(Speed), max_speed = max(Speed))
head(speed_range, 15)
```
```{r}
# Merge 2 dataframes together based on ID_test
df_merge <- merge(subject_info,test_measure,by="ID_test")
```

```{r}
head(df_merge,15)
dim(df_merge)
```
```{r}
#To make data time independent, we will average across all measurements for each speed range in an ID_test. Since the same ID_test can have multiple speeds, meaning the same participant will have multiple measurements in the data. 

#Make a speed category, which puts speed ranges into a category. For example, any speed that falls between 0 and 1 is speed 0, and any speed that is between 1 and 2 is speed 1. We do this because not everyone runs at the same speed for the tests. 

df_merge = df_merge%>%mutate(Speed_Category = case_when(
    Speed >= 0 & Speed < 1 ~ "0",
    Speed >= 1 & Speed < 2 ~ "1",
    Speed >= 2 & Speed < 3 ~ "2",
    Speed >= 3 & Speed < 4 ~ "3",
    Speed >= 4 & Speed < 5 ~ "4",
    Speed >=5  & Speed < 6 ~ "5",
    Speed >=6  & Speed < 7 ~ "6",
    Speed >=7  & Speed < 8 ~ "7",
    Speed >=8  & Speed < 9 ~ "8",
    Speed >=9  & Speed < 10 ~ "9",
    Speed >=10 & Speed < 11 ~ "10",
    Speed >=11 & Speed < 12 ~ "11",
    Speed >=12 & Speed < 13 ~ "12",
    Speed >=13 & Speed < 14 ~ "13",
    Speed >=14 & Speed < 15 ~ "14",
    Speed >=15 & Speed < 16 ~ "15",
    Speed >=16 & Speed < 17 ~ "16",
    Speed >=17 & Speed < 18 ~ "17",
    Speed >=18 & Speed < 19 ~ "18",
    Speed >=19 & Speed < 20 ~ "19",
    Speed >=20 & Speed < 21 ~ "20",
    Speed >=21 & Speed < 22 ~ "21",
    Speed >=22 & Speed < 23 ~ "22",
    Speed >=23 & Speed < 24 ~ "23"
  ))

head(df_merge,10)
```

```{r}
# Find avg speed, HR, VO2, VCO2, RR based on ID and test
df_merge$Sex <- as.numeric(df_merge$Sex)
class(stroke_data$bmi)
id_merged <- ddply(df_merge, "ID_test", summarise, bmi = mean(bmi), age=mean(Age), Sex=mean(Sex), avg_speed=mean(Speed), avg_HR=mean(HR, na.rm=TRUE), avg_VO2=mean(VO2,na.rm=TRUE), avg_VCO2=mean(VCO2, na.rm=TRUE), avg_RR=mean(RR, na.rm=TRUE), avg_VE=mean(VE, na.rm=TRUE))
id_merged$Sex <- as.character(id_merged$Sex)
class(stroke_data$bmi)
head(id_merged)
dim(id_merged)
```


```{r}
# Find avg speed, HR, VO2, VCO2, RR based on gender
avg_merged <- ddply(df_merge, "Sex", summarise, avg_speed=mean(Speed), avg_HR=mean(HR, na.rm=TRUE), avg_VO2=mean(VO2,na.rm=TRUE), avg_VCO2=mean(VCO2, na.rm=TRUE))
avg_merged$Sex <- as.character(avg_merged$Sex)
head(avg_merged)
```
```{r}
#Graph density function
id_merged$sex = as.character(id_merged$Sex)
speed_density = ggplot(id_merged, aes(x=avg_speed, fill=Sex, color=Sex)) +
  geom_density(alpha = 0.5) +
  #Add mean lines
  geom_vline(data=avg_merged, aes(xintercept=avg_speed, color=Sex), linetype="dashed") +
  labs(title ="Speed Density across Sex",
       x = "Speed (km/hr)",
       y = "Density") +
  theme(text = element_text(size=20))
# Add tickmarks for every 5 years for age 
speed_density = speed_density + scale_x_continuous(breaks=seq(0, 15, 1)) + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank())
speed_density
ggsave("speed_density.png")
```
```{r}
# 1x2 grid speed and age density plots for proposal 
density_grid = grid.arrange(age_density,speed_density, ncol = 1)
ggsave("density_grid.png", density_grid)
```
```{r}
library(patchwork)
age_density + speed_density
```


```{r}
#Female 
female = filter(df_merge, Sex == 1)
dim(female)
head(female)

#Male
male = filter(df_merge, Sex == 0)
dim(male)

#Uneven distr of tests, mostly male
```

```{r}
# Find count of number of tests per speed
freq_speed = count(test_measure, vars =c('Speed'))
head(freq_speed)
dim(freq_speed)

freq_female_speed = count(female, vars =c('Speed'))
head(freq_female_speed)
dim(freq_female_speed)

freq_male_speed = count(male, vars =c('Speed'))
head(male_speed)
dim(male_speed)
```


```{r}
# Distribution of speed histogram
bw1 <- 2 * IQR(df_merge$Speed) / length(df_merge$Speed)^(1/3)
bw2 <- 2 * IQR(female$Speed) / length(female$Speed)^(1/3)
bw3 <- 2 * IQR(male$Speed) / length(male$Speed)^(1/3)

speed_hist <- ggplot(df_merge, aes(x=Speed)) +
  geom_histogram(binwidth = bw1) +
  ggtitle("Original Speed Distribution")

# Female speed histogram
female_speed <- ggplot(female, aes(x=Speed)) +
  geom_histogram(binwidth = bw2) +
  ggtitle("Female Speed Distriubtion")

# Male speed histogram
male_speed <- ggplot(male, aes(x=Speed)) +
  geom_histogram(binwidth = bw3) +
  ggtitle("Male Speed Distriubtion")

# 3x1 grid of histograms
grid.arrange(speed_hist, female_speed, male_speed, nrow=3)
```
```{r}
# Look at HR at speed = 5 based on gender
speed5 = filter(df_merge, Speed == 5)
speed5 $Sex <-as.character(speed5$Sex)
dim(speed5)
head(speed5)
```
```{r}
# Speed = 5, age on x
speed5_age_density = ggplot(speed5, aes(x=Age, fill=Sex, color=Sex)) +
  #geom_histogram(aes(y=..density..))+ #Add density plot
  geom_density(alpha = 0.5) +
  # Add mean lines
  #geom_vline(data=age_mean, aes(xintercept=grp.mean, color=Sex), linetype="dashed") +
  labs(x = "Age",
       y = "Density",
       subtitle="Age of Female vs. Male Participants at Speed 5")
# Add tickmarks for every 5 years for age 
speed5_age_density + scale_x_continuous(breaks=seq(0, 80, 5))
```

```{r}
# Remove all values greater than 3 standard deviations from the mean

# Remove bmi outliers
new_bmi <- subset(id_merged,  id_merged$bmi <= (3*sd(id_merged$bmi , na.rm=TRUE) + mean(id_merged$bmi , na.rm = TRUE)))

# Remove age outliers
new_age <- subset(id_merged,  id_merged$age <= (3*sd(id_merged$age , na.rm=TRUE) + mean(id_merged$age , na.rm = TRUE)))

# Remove speed outliers
new_speed <- subset(id_merged,  id_merged$avg_speed <= (3*sd(id_merged$avg_speed , na.rm=TRUE) + mean(id_merged$avg_speed , na.rm = TRUE)))
head(new_speed)

# Remove HR outliers
new_HR <- subset(id_merged,  id_merged$avg_HR <= (3*sd(id_merged$avg_HR , na.rm=TRUE) + mean(id_merged$avg_HR , na.rm = TRUE)))

# Remove VO2 outliers
new_VO2 <- subset(id_merged, id_merged$avg_VO2 <= (3*sd(id_merged$avg_VO2 , na.rm=TRUE) + mean(id_merged$avg_VO2 , na.rm = TRUE)))

# Remove VCO2 outliers
new_VCO2 <- subset(id_merged, id_merged$avg_VCO2 <= (3*sd(id_merged$avg_VCO2 , na.rm=TRUE) + mean(id_merged$avg_VCO2 , na.rm = TRUE)))

# Remove RR outliers
new_RR <- subset(id_merged, id_merged$avg_RR <= (3*sd(id_merged$avg_RR , na.rm=TRUE) + mean(id_merged$avg_RR , na.rm = TRUE)))

# Remove VE outliers
new_VE <- subset(id_merged, id_merged$avg_VE <= (3*sd(id_merged$avg_VE , na.rm=TRUE) + mean(id_merged$avg_VE , na.rm = TRUE)))
```

```{r}
# BMI outliers
bmi_outliers <- subset(id_merged,  id_merged$bmi > (3*sd(id_merged$bmi , na.rm=TRUE) + mean(id_merged$bmi , na.rm = TRUE)))
nrow(bmi_outliers)

# Age outliers
age_outliers <- subset(id_merged,  id_merged$age > (3*sd(id_merged$age , na.rm=TRUE) + mean(id_merged$age , na.rm = TRUE)))
nrow(age_outliers)

# Speed outliers
speed_outliers <- subset(id_merged, id_merged$avg_speed > (3*sd(id_merged$avg_speed, na.rm=TRUE)) + mean(id_merged$avg_speed, na.rm = TRUE))
nrow(speed_outliers)

# HR outliers
HR_outliers <- subset(id_merged,  id_merged$avg_HR > (3*sd(id_merged$avg_HR , na.rm=TRUE) + mean(id_merged$avg_HR , na.rm = TRUE)))
nrow(HR_outliers)

# VO2 outliers
VO2_outliers <- subset(id_merged, id_merged$avg_VO2 > (3*sd(id_merged$avg_VO2 , na.rm=TRUE) + mean(id_merged$avg_VO2 , na.rm = TRUE)))
nrow(VO2_outliers)

# VCO2 outliers
VCO2_outliers <- subset(id_merged, id_merged$avg_VCO2 > (3*sd(id_merged$avg_VCO2 , na.rm=TRUE) + mean(id_merged$avg_VCO2 , na.rm = TRUE)))
nrow(VCO2_outliers)

# RR outliers
RR_outliers <- subset(id_merged, id_merged$avg_RR > (3*sd(id_merged$avg_RR , na.rm=TRUE) + mean(id_merged$avg_RR , na.rm = TRUE)))
nrow(RR_outliers)

# VE outliers
VE_outliers <- subset(id_merged, id_merged$avg_VE > (3*sd(id_merged$avg_VE , na.rm=TRUE) + mean(id_merged$avg_VE , na.rm = TRUE)))
nrow(VE_outliers)
```
```{r}
# Create box plots for avg speed, HR, VO2, and VCO2 across gender after removing outliers
library(grid)

# Speed box plot
speed_box <- ggplot(new_speed, aes(x=sex, y=avg_speed)) +
  geom_boxplot() +
  labs(x="Sex", y="Speed (km/hr)") +
  theme(text = element_text(size=15))
speed_box = speed_box + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank())

# HR box plot
HR_box <- ggplot(new_HR, aes(x=sex, y=avg_HR)) +
  geom_boxplot() +
  labs(x="Sex", y="HR (bpm)") +
  theme(text = element_text(size=15))
HR_box = HR_box + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank())
ggsave("HR_box.png")

# V02 box plot
VO2_box <- ggplot(new_VO2, aes(x=sex, y=avg_VO2)) +
  geom_boxplot() +
  labs(x="Sex", y="VO2 (ml/min)") +
  theme(text = element_text(size=15))
VO2_box  = VO2_box + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank())
ggsave("VO2_box.png")

# VC02 box plot
VCO2_box <- ggplot(new_VCO2, aes(x=sex, y=avg_VCO2)) +
  geom_boxplot() +
  labs(x="Sex", y="VCO2 (ml/min)") +
  theme(text = element_text(size=15))
VCO2_box  = VCO2_box + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank())

# RR box plot
RR_box <- ggplot(new_RR, aes(x=sex, y=avg_RR)) +
  geom_boxplot() +
  labs(x="Sex", y="RR (respiration/min)") +
  theme(text = element_text(size=15))
RR_box = RR_box + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank())

# VE box plot
VE_box <- ggplot(new_VE, aes(x=sex, y=avg_VCO2)) +
  geom_boxplot() +
  labs(x="Sex", y="VE (L/min)") +
  theme(text = element_text(size=15))

VE_box = VE_box + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank())

ggsave("VCO2_box.png")
# 1x6 grid of box plots

plots = grid.arrange(speed_box, HR_box, VO2_box, VCO2_box, RR_box, VE_box, nrow = 2, ncol=3,
                     top=textGrob("Average Physiological Measurements across Sex", gp=gpar(fontsize=15,font=8)))
ggsave("plots.png", plots)
```

```{r}
# Find correlation in all numeric values with are age, bmi, speed, HR, VO2, and VCO2
# Convert stroke back to integer
id_merged$Sex <- as.integer(id_merged$Sex)
numeric_data <- id_merged[,c("Sex","age","avg_speed","bmi","avg_HR","avg_VCO2","avg_VO2", "avg_RR", "avg_VE")]
matrix = cor(numeric_data, use="complete.obs")
matrix
png(height=1800, width=1800, file="correlation_matrix.png")
corrplot(matrix, tl.col = "black", tl.srt = 45, tl.cex=5, cl.cex=5, bg = "White",
         title = "\n\n Correlation Plot Of Features",
         type = "lower")
dev.off()
corrplot(matrix, tl.col = "black",bg = "White",
         title = "\n\n Correlation Plot Of Features",
         type = "lower")
```
```{r}
library(reshape2)
melted_gamb <- melt(matrix)
head(melted_gamb)
corrplot = ggplot(data = melted_gamb, aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient2(midpoint = 0, low = "red", high = "blue3", 
                       limits = c(-1, +1)) +
  labs(title = "Correlation Matrix On Treadmill Maximal Exercise Data ", 
       x = "", y = "", fill = "Correlation \n Measure \n") +
  theme(plot.title = element_text(hjust = 0.5, colour = "black"), 
        axis.title.x = element_text(face="bold", colour="black"),
        axis.title.y = element_text(face="bold", colour="black"),
        legend.title = element_text(colour="black", size = 15),
        text = element_text(size=13),
        panel.background = element_blank(), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  geom_text(aes(x = Var1, y = Var2, label = round(value, 2)), color = "black", 
            fontface = "bold", size = 5)

corrplot = corrplot
corrplot
ggsave("correlation_matrix.png")
```

```{r}
pairs(id_merged[,2:10], pch = 19)
```
```{r}
#Look at scatterplots for speed = 5 and speed = 15
id_merged_5 = filter(df_merge, Speed == 5)
id_merged_5 <- ddply(id_merged_5, "ID_test", summarise, bmi = mean(bmi), age=mean(Age), sex=mean(Sex), avg_speed=mean(Speed), avg_HR=mean(HR, na.rm=TRUE), avg_VO2=mean(VO2,na.rm=TRUE), avg_VCO2=mean(VCO2, na.rm=TRUE), avg_RR=mean(RR, na.rm=TRUE), avg_VE=mean(VE, na.rm=TRUE))
head(id_merged_5)
dim(id_merged_5)
pairs(id_merged_5[,2:10], pch = 19)
```

Notes, new
predicting per
exercise measurememts to prodice age
ppl who wear wearables but diificult to predict age or gender

feature engineering ti predict perfamce 
one hot encoding convert category to numerical, be ordinal 

one type of variable easier to meeasure 


